{% extends 'base.html' %}
{% block title %}Calendar â€” IIC Club{% endblock %}
{% block page_title %}ğŸ“… Club Calendar{% endblock %}

{% block content %}
<!-- Calendar Navigation -->
<div class="calendar-header">
    <div class="calendar-nav">
        <a href="{{ url_for('views.calendar_view', year=year, month=month-1, user_id=view_user.id) }}"
            class="btn btn-secondary btn-sm">â† Prev</a>
        <div class="calendar-month">{{ month_name }} {{ year }}</div>
        <a href="{{ url_for('views.calendar_view', year=year, month=month+1, user_id=view_user.id) }}"
            class="btn btn-secondary btn-sm">Next â†’</a>
    </div>
    <div class="d-flex align-center gap-2">
        <!-- User selector -->
        <form method="GET" action="{{ url_for('views.calendar_view') }}" class="d-flex align-center gap-1">
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
            <select name="user_id" class="form-control" style="width: auto; font-size: 12px;"
                onchange="this.form.submit()">
                <option value="">My Calendar</option>
                {% for m in all_members %}
                <option value="{{ m.id }}" {% if view_user.id==m.id and view_user.id !=current_user.id %}selected{%
                    endif %}>
                    {{ m.name }} ({{ m.role }})
                </option>
                {% endfor %}
            </select>
        </form>
        {% if current_user.can_manage_calendar() %}
        <button class="btn btn-primary" onclick="openModal('addEventModal')">+ Add Event</button>
        {% endif %}
    </div>
</div>

{% if view_user.id != current_user.id %}
<div
    style="margin-bottom: 12px; padding: 8px 12px; background: var(--surface-2); border-radius: 4px; font-size: 12px; color: var(--text-dim);">
    ğŸ‘¤ Viewing calendar for <strong style="color: #fff;">{{ view_user.name }}</strong> ({{ view_user.role }})
</div>
{% endif %}

<!-- Calendar Grid -->
<div class="calendar-grid">
    <div class="calendar-day-header">Sun</div>
    <div class="calendar-day-header">Mon</div>
    <div class="calendar-day-header">Tue</div>
    <div class="calendar-day-header">Wed</div>
    <div class="calendar-day-header">Thu</div>
    <div class="calendar-day-header">Fri</div>
    <div class="calendar-day-header">Sat</div>

    {% for week in month_cal %}
    {% for day in week %}
    <div class="calendar-day {% if day == 0 %}empty{% endif %} {% if day == today.day and month == today.month and year == today.year %}today{% endif %}">
        {% if day != 0 %}
        <div class="calendar-day-num">{{ day }}</div>
        
        <!-- Events -->
        {% if day in event_map %}
        {% for event in event_map[day] %}
        <div class="calendar-event" 
             onclick="window.location.href='{{ url_for('views.event_details', event_id=event.id) }}'"
             title="{{ event.title }}" style="cursor:pointer;">
            ğŸ“… {{ event.title }}
        </div>
        {% endfor %}
        {% endif %}

        <!-- Tasks -->
        {% if day in task_map %}
        {% for task in task_map[day] %}
        <div class="calendar-event task-event" 
             onclick="showEventDetail('task', {{ task.id }}, '{{ task.title|escape }}', '', '', 'Status: {{ task.status }}')"
             title="Task: {{ task.title }}">
            âœ… {{ task.title }}
        </div>
        {% endfor %}
        {% endif %}
        
        {% endif %}
    </div>
    {% endfor %}
    {% endfor %}
</div>

<!-- Event Detail Modal (For Tasks) -->
<div class="modal-overlay" id="eventDetailModal">
    <div class="modal" style="max-width: 400px; width: 90%;">
        <div class="modal-header">
            <h2 class="modal-title" id="detailTitle">Details</h2>
            <button class="modal-close" onclick="closeModal('eventDetailModal')">âœ•</button>
        </div>
        <div id="detailContent" style="font-size: 0.95rem; line-height: 1.6; color: var(--text);">
            <!-- Populated by JS -->
        </div>
        <div class="d-flex justify-end mt-3" id="detailFooter" style="border-top: 1px solid var(--border); padding-top: 1rem;">
            <button class="btn btn-secondary btn-sm" onclick="closeModal('eventDetailModal')">Close</button>
        </div>
    </div>
</div>

<script>
function showEventDetail(type, id, title, time, location, desc) {
    document.getElementById('detailTitle').innerText = title;
    
    let html = '';
    if (type === 'event') {
        // This context presumably won't be used since events link to event_details, but keeping just in case
        if (time) html += `<div class="d-flex align-center gap-2 mb-2"><span class="text-dim">ğŸ•</span> <span>${time}</span></div>`;
        if (location) html += `<div class="d-flex align-center gap-2 mb-2"><span class="text-dim">ğŸ“</span> <span>${location}</span></div>`;
        if (desc) html += `<div class="mt-3 p-2 bg-surface rounded text-dim" style="white-space: pre-wrap;">${desc}</div>`;
        html += `<div class="mt-3"><a href="/events/${id}" class="btn btn-primary btn-sm w-100">View Full Details</a></div>`;
    } else {
        html += `<div class="mb-2"><span class="badge badge-sheet">TASK</span></div>`;
        if (desc) html += `<div class="mb-3 text-dim">${desc}</div>`;
        html += `<div class="mt-2"><a href="/tasks" class="btn btn-primary btn-sm w-100">Go to Task Board</a></div>`;
    }
    
    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('eventDetailModal').style.display = 'flex';
}
</script>

<!-- Upcoming Events -->
<div class="events-sidebar mt-3">
    <h3 class="card-title mb-2">ğŸ“‹ Upcoming Events</h3>
    {% if upcoming %}
    {% for event in upcoming %}
    <div class="event-item" onclick="window.location.href='{{ url_for('views.event_details', event_id=event.id) }}'" style="cursor:pointer;">
        <div class="event-date-badge">
            <span class="event-day">{{ event.event_date.strftime('%d') }}</span>
            <span class="event-month-short">{{ event.event_date.strftime('%b') }}</span>
        </div>
        <div class="event-info" style="flex: 1;">
            <div class="event-title">{{ event.title }}</div>
            <div class="event-detail">
                {% if event.event_time %}ğŸ• {{ event.event_time }}{% endif %}
                {% if event.location %} Â· ğŸ“ {{ event.location }}{% endif %}
            </div>
            {% if event.description %}
            <div class="event-detail mt-1" style="display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;">
                {{ event.description }}
            </div>
            {% endif %}
        </div>
        {% if current_user.can_manage_calendar() %}
        <form id="deleteEvent{{ event.id }}" method="POST"
            action="{{ url_for('views.delete_event', event_id=event.id) }}" onclick="event.stopPropagation();">
            <button type="button" class="btn btn-sm btn-danger"
                onclick="confirmDelete('deleteEvent{{ event.id }}', '{{ event.title }}')">ğŸ—‘ï¸</button>
        </form>
        {% endif %}
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ğŸ“­</div>
        <p class="empty-text">No upcoming events</p>
    </div>
    {% endif %}
</div>

<!-- Add Event Modal -->
{% if current_user.can_manage_calendar() %}
<div class="modal-overlay" id="addEventModal">
    <div class="modal" style="width: 100%; max-width: 480px;">
        <div class="modal-header">
            <h2 class="modal-title">âœ¨ Add New Event</h2>
            <button class="modal-close" onclick="closeModal('addEventModal')">âœ•</button>
        </div>
        <form method="POST" action="{{ url_for('views.add_event') }}">
            <div class="form-row" style="gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group" style="flex: 2;">
                    <label class="form-label" for="title">Event Title <span style="color:var(--red)">*</span></label>
                    <div class="d-flex align-center bg-surface rounded border-1" style="padding: 0 0.75rem;">
                        <span style="font-size:1.2rem;">ğŸ“…</span>
                        <input type="text" id="title" name="title" class="form-control border-0" placeholder="e.g. Weekly Standup" required style="box-shadow:none;">
                    </div>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label" for="event_type">Type</label>
                    <select id="event_type" name="event_type" class="form-control" style="padding: 0.6rem;">
                        <option value="event">ğŸ‰ Event</option>
                        <option value="meeting">ğŸ¤ Meeting</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row" style="gap: 1rem; margin-bottom: 1rem;">
                <div class="form-group" style="flex: 1;">
                    <label class="form-label" for="event_date">Date <span style="color:var(--red)">*</span></label>
                    <input type="date" id="event_date" name="event_date" class="form-control" required style="padding: 0.6rem;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label class="form-label" for="event_time">Time</label>
                    <input type="text" id="event_time" name="event_time" class="form-control" placeholder="e.g. 3:00 PM" style="padding: 0.6rem;">
                </div>
            </div>
            
            <div class="form-group mb-3">
                <label class="form-label" for="location">Location</label>
                <div class="d-flex align-center bg-surface rounded border-1" style="padding: 0 0.75rem;">
                    <span style="font-size:1.2rem;">ğŸ“</span>
                    <input type="text" id="location" name="location" class="form-control border-0" placeholder="e.g. Room 301 or Zoom Link" style="box-shadow:none;">
                </div>
            </div>
            
            <div class="form-group mb-4">
                <label class="form-label" for="description">Description</label>
                <textarea id="description" name="description" class="form-control" rows="3" placeholder="What is this event about?" style="resize:vertical; min-height:80px;"></textarea>
            </div>
            
            <button type="submit" class="btn btn-primary w-100 py-2" style="font-size:1rem; font-weight:600;">Create & Notify Members ğŸ””</button>
        </form>
    </div>
</div>
{% endif %}
{% endblock %}