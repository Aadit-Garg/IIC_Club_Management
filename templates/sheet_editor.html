{% extends "base.html" %}
{% block title %}{{ sheet.name }} ‚Äî Editor{% endblock %}
{% block page_title %}üìä {{ sheet.name }}{% endblock %}

{% block head %}
<style>
    /* ‚îÄ‚îÄ Google Sheets Clone ‚îÄ‚îÄ */
    .page-content:has(.gs-page) { padding: 0 !important; overflow: hidden; }
    .gs-page { 
        display: flex; 
        flex-direction: column; 
        height: calc(100vh - var(--topbar-h)); 
        background: var(--bg); 
        font-family: 'Inter', Arial, sans-serif; 
        color: var(--text);
    }

    /* Top bar */
    .gs-header {
        display: flex; align-items: center; gap: 10px;
        padding: 8px 16px; 
        background: var(--surface); 
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-bottom: 1px solid var(--border);
    }
    .gs-back { text-decoration: none; color: var(--text); font-size: 18px; padding: 4px 8px; border-radius: var(--radius); transition: all 0.2s; }
    .gs-back:hover { background: var(--glass-bg); border: 1px solid var(--glass-border); }
    .gs-sheet-name { font-size: 14px; font-weight: 600; color: var(--text); }
    .gs-sheet-meta { font-size: 10px; color: var(--text-dim); }
    .gs-save-badge { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 11px; color: var(--text-dim); }
    .gs-save-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); transition: background 0.3s; }
    .gs-save-dot.saved { background: var(--green); box-shadow: 0 0 8px var(--green); }

    /* Toolbar */
    .gs-toolbar {
        display: flex; align-items: center; gap: 2px;
        padding: 4px 12px; 
        background: var(--surface-2); 
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border-bottom: 1px solid var(--border);
        flex-wrap: wrap;
    }
    .gs-tb-btn {
        width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
        background: transparent; border: 1px solid transparent; border-radius: var(--radius);
        color: var(--text); cursor: pointer; font-size: 13px; font-weight: 500;
        transition: all 0.2s;
    }
    .gs-tb-btn:hover { background: var(--glass-bg); border-color: var(--glass-border); }
    .gs-tb-btn.active { background: var(--accent); color: var(--black); }
    .gs-tb-sep { width: 1px; height: 20px; background: var(--border); margin: 0 4px; }
    .gs-tb-select {
        height: 26px; padding: 0 6px; font-size: 12px; border: 1px solid transparent;
        border-radius: var(--radius); background: transparent; cursor: pointer; color: var(--text);
        transition: all 0.2s;
    }
    .gs-tb-select option { background: var(--bg); color: var(--text); }
    .gs-tb-select:hover { background: var(--glass-bg); border-color: var(--border); }
    .gs-tb-select:focus { outline: none; border-color: var(--accent); }

    /* Color picker wrapper */
    .gs-color-wrap {
        position: relative; width: 28px; height: 28px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; border-radius: var(--radius); font-size: 14px; font-weight: 700;
        transition: all 0.2s;
    }
    .gs-color-wrap:hover { background: var(--glass-bg); border: 1px solid var(--glass-border); }
    .gs-color-bar {
        position: absolute; bottom: 3px; left: 5px; right: 5px; height: 3px;
        border-radius: 1px; pointer-events: none;
    }
    .gs-color-wrap input[type="color"] {
        position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; top: 0; left: 0;
    }

    /* Dropdown */
    .gs-dropdown { position: relative; display: inline-flex; }
    .gs-dropdown-menu {
        display: none; position: absolute; top: 100%; left: 0;
        background: var(--surface); 
        backdrop-filter: var(--blur);
        -webkit-backdrop-filter: var(--blur);
        border: 1px solid var(--border); 
        border-radius: var(--radius);
        box-shadow: 0 4px 20px rgba(0,0,0,0.5); z-index: 100;
        min-width: 160px; padding: 6px 0;
        margin-top: 4px;
    }
    .gs-dropdown.open .gs-dropdown-menu { display: block; }
    .gs-dropdown-item {
        padding: 8px 16px; font-size: 12px; cursor: pointer; color: var(--text);
        transition: all 0.2s;
    }
    .gs-dropdown-item:hover { background: var(--glass-bg); color: var(--accent); }

    .gs-tb-export {
        margin-left: auto; padding: 4px 12px; font-size: 12px; font-weight: 500;
        background: var(--accent); color: var(--black); border: none; border-radius: var(--radius); cursor: pointer;
        transition: all 0.2s;
    }
    .gs-tb-export:hover { opacity: 0.9; transform: translateY(-1px); }

    /* Formula bar */
    .gs-formula-bar {
        display: flex; align-items: center; border-bottom: 1px solid var(--border); background: var(--bg);
    }
    .gs-cell-ref {
        width: 60px; text-align: center; padding: 6px 4px;
        font-size: 12px; font-weight: 600; color: var(--accent);
        border-right: 1px solid var(--border); background: var(--surface);
    }
    .gs-fx { padding: 6px 10px; color: var(--text-muted); font-size: 12px; font-style: italic; border-right: 1px solid var(--border); }
    .gs-formula-input {
        flex: 1; padding: 6px 12px; border: none; outline: none;
        font-size: 13px; color: var(--text); background: transparent;
    }

    /* Grid container */
    .gs-grid-wrap { flex: 1; overflow: auto; background: var(--bg); position: relative; }
    .gs-grid-wrap:focus { outline: none; }

    /* Table */
    table.gs-tbl { border-collapse: collapse; table-layout: fixed; background: var(--bg); }

    /* Corner */
    table.gs-tbl th.corner {
        position: sticky; top: 0; left: 0; z-index: 20;
        width: 36px; min-width: 36px; background: var(--surface-2); border: 1px solid var(--border);
    }

    /* Column headers */
    table.gs-tbl th.ch {
        position: sticky; top: 0; z-index: 10;
        height: 24px; background: var(--surface-2); color: var(--text-dim); font-size: 11px; font-weight: 600;
        text-align: center; border: 1px solid var(--border); user-select: none;
    }
    table.gs-tbl th.ch.hl { background: var(--glass-bg); color: var(--accent); }

    /* Resize handle on column */
    .col-resize {
        position: absolute; top: 0; right: -2px; width: 5px; height: 100%;
        cursor: col-resize; z-index: 15;
    }
    .col-resize:hover { background: var(--accent); }

    /* Row headers */
    table.gs-tbl td.rh {
        position: sticky; left: 0; z-index: 5;
        width: 36px; min-width: 36px; background: var(--surface-2); color: var(--text-dim);
        font-size: 10px; text-align: center; border: 1px solid var(--border); user-select: none;
    }
    table.gs-tbl td.rh.hl { background: var(--glass-bg); color: var(--accent); }

    /* Resize handle on row */
    .row-resize {
        position: absolute; bottom: -2px; left: 0; width: 100%; height: 5px;
        cursor: row-resize; z-index: 15;
    }
    .row-resize:hover { background: var(--accent); }

    /* Data cells */
    table.gs-tbl td.c {
        height: 22px; padding: 0; border: 1px solid var(--border); background: transparent;
        position: relative; color: var(--text); overflow: hidden;
    }

    .cv {
        width: 100%; height: 100%; padding: 1px 6px;
        font-size: 12px; line-height: 22px; overflow: hidden;
        text-overflow: ellipsis; white-space: nowrap; cursor: cell;
        color: inherit;
    }
    .cv a { color: var(--blue); text-decoration: underline; pointer-events: none; }

    /* Selection */
    table.gs-tbl td.c.sel { background: var(--glass-bg) !important; }
    table.gs-tbl td.c.active { outline: 2px solid var(--accent); outline-offset: -1.5px; z-index: 2; }
    table.gs-tbl td.c.editing { z-index: 3; }

    /* Edit input */
    .gs-edit {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        padding: 1px 6px; border: none; outline: none;
        background: var(--surface-2); color: var(--text); font-size: 12px; line-height: 22px;
        z-index: 4; box-sizing: border-box;
    }

    /* Footer */
    .gs-footer {
        display: flex; align-items: center; gap: 16px;
        padding: 4px 16px; background: var(--surface); border-top: 1px solid var(--border);
        font-size: 11px; color: var(--text-dim); min-height: 24px;
    }
</style>
{% endblock %}

{% block content %}
<div class="gs-page">
    <div class="gs-header">
        <a href="{{ url_for('views.sheets') }}" class="gs-back">‚Üê</a>
        <div>
            <div class="gs-sheet-name">{{ sheet.name }}</div>
            <div class="gs-sheet-meta">{{ sheet.creator.name }}</div>
        </div>
        <div class="gs-save-badge">
            <div class="gs-save-dot" id="sDot"></div>
            <span id="sStatus">Ready</span>
        </div>
    </div>

    <div class="gs-toolbar">
        <button class="gs-tb-btn" onclick="undo()" title="Undo (Ctrl+Z)" style="font-size:16px;">‚Ü∂</button>
        <div class="gs-tb-sep"></div>
        <select class="gs-tb-select" id="tbFs" onchange="fmtFs(+this.value)" title="Font size">
            <option value="8">8</option><option value="9">9</option><option value="10">10</option>
            <option value="11">11</option><option value="12" selected>12</option><option value="14">14</option>
            <option value="16">16</option><option value="18">18</option><option value="20">20</option>
            <option value="24">24</option><option value="36">36</option>
        </select>
        <div class="gs-tb-sep"></div>
        <button class="gs-tb-btn" id="tbB" onclick="fmt('bold')" title="Bold (Ctrl+B)"><b>B</b></button>
        <button class="gs-tb-btn" id="tbI" onclick="fmt('italic')" title="Italic (Ctrl+I)"><i>I</i></button>
        <button class="gs-tb-btn" id="tbU" onclick="fmt('underline')" title="Underline (Ctrl+U)"><u>U</u></button>
        <div class="gs-tb-sep"></div>
        <div class="gs-color-wrap" title="Text color">
            <span style="color:#333;">A</span>
            <div class="gs-color-bar" id="fgBar" style="background:#333333"></div>
            <input type="color" id="tbFg" value="#333333" onchange="fmtColor('fg',this.value)">
        </div>
        <div class="gs-color-wrap" title="Fill color">
            <span>ü™£</span>
            <div class="gs-color-bar" id="bgBar" style="background:#ffffff"></div>
            <input type="color" id="tbBg" value="#ffffff" onchange="fmtColor('bg',this.value)">
        </div>
        <div class="gs-tb-sep"></div>
        <div class="gs-dropdown" id="borderDD">
            <button class="gs-tb-btn" onclick="toggleDD('borderDD')" title="Borders" style="font-size:14px;">‚ñ¶</button>
            <div class="gs-dropdown-menu">
                <div class="gs-dropdown-item" onclick="fmtBorder('all')">‚ñ¶ All borders</div>
                <div class="gs-dropdown-item" onclick="fmtBorder('outer')">‚óª Outer borders</div>
                <div class="gs-dropdown-item" onclick="fmtBorder('none')">‚ä† No borders</div>
                <div class="gs-dropdown-item" onclick="fmtBorder('top')">‚ñî Top border</div>
                <div class="gs-dropdown-item" onclick="fmtBorder('bottom')">‚ñÅ Bottom border</div>
                <div class="gs-dropdown-item" onclick="fmtBorder('left')">‚ñè Left border</div>
                <div class="gs-dropdown-item" onclick="fmtBorder('right')">‚ñï Right border</div>
            </div>
        </div>
        <div class="gs-tb-sep"></div>
        <div class="gs-dropdown" id="mergeDD">
            <button class="gs-tb-btn" onclick="toggleDD('mergeDD')" title="Merge cells" style="font-size:16px;">‚öØ</button>
            <div class="gs-dropdown-menu">
                <div class="gs-dropdown-item" onclick="doMerge()">Merge cells</div>
                <div class="gs-dropdown-item" onclick="unMerge()">Unmerge cells</div>
            </div>
        </div>
        <button class="gs-tb-btn" onclick="addLink()" title="Hyperlink" style="font-size:13px;">üîó</button>
        <div class="gs-tb-sep"></div>
        <button class="gs-tb-btn" onclick="fmt('left')" title="Align Left">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/></svg>
        </button>
        <button class="gs-tb-btn" onclick="fmt('center')" title="Align Center">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/></svg>
        </button>
        <button class="gs-tb-btn" onclick="fmt('right')" title="Align Right">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zm-6-6v2h18V3H3z"/></svg>
        </button>
        <div class="gs-tb-sep"></div>
        <button class="gs-tb-export" onclick="exportCSV()">‚¨á Export CSV</button>
    </div>

    <div class="gs-formula-bar">
        <div class="gs-cell-ref" id="cellRef">A1</div>
        <div class="gs-fx">fx</div>
        <input class="gs-formula-input" id="formulaInput" placeholder="Enter value...">
    </div>

    <div class="gs-grid-wrap" id="gw" tabindex="0">
        <table class="gs-tbl" id="tbl"></table>
    </div>

    <div class="gs-footer">
        <span id="footInfo"></span>
    </div>
</div>

<script>
(function(){
    const SID = {{ sheet.id }};
    const R = 50, C = 26;
    const L = i => String.fromCharCode(65+i);

    let data = {}, anchor = null, cursor = null, selEnd = null;
    let dragging = false, editing = false, editCell = null;
    let saveT = null, dirty = new Set();
    let colW = Array(C).fill(80);
    let rowH = Array(R).fill(22);
    let merges = [];
    let occupied = {};
    let resizing = null;

    const tbl = document.getElementById('tbl');
    const gw = document.getElementById('gw');
    const cellRef = document.getElementById('cellRef');
    const formulaInput = document.getElementById('formulaInput');
    const footInfo = document.getElementById('footInfo');

    // ‚îÄ‚îÄ Merge helpers ‚îÄ‚îÄ
    function updateOccupied() {
        occupied = {};
        merges.forEach(m => {
            for (let r = m.r1; r <= m.r2; r++)
                for (let c = m.c1; c <= m.c2; c++)
                    if (r !== m.r1 || c !== m.c1) occupied[`${r},${c}`] = true;
        });
    }
    function getMerge(r, c) {
        return merges.find(m => r >= m.r1 && r <= m.r2 && c >= m.c1 && c <= m.c2);
    }

    // ‚îÄ‚îÄ Build table ‚îÄ‚îÄ
    function buildTable() {
        let h = '<colgroup><col style="width:36px">';
        for (let c = 0; c < C; c++) h += `<col style="width:${colW[c]}px" data-c="${c}">`;
        h += '</colgroup><thead><tr><th class="corner"></th>';
        for (let c = 0; c < C; c++)
            h += `<th class="ch" data-c="${c}" style="position:relative;">${L(c)}<div class="col-resize" data-c="${c}"></div></th>`;
        h += '</tr></thead><tbody>';
        for (let r = 0; r < R; r++) {
            h += `<tr style="height:${rowH[r]}px"><td class="rh" data-r="${r}" style="position:relative;">${r+1}<div class="row-resize" data-r="${r}"></div></td>`;
            for (let c = 0; c < C; c++) {
                if (occupied[`${r},${c}`]) continue;
                const mg = getMerge(r, c);
                const rs = mg ? mg.r2 - mg.r1 + 1 : 1;
                const cs = mg ? mg.c2 - mg.c1 + 1 : 1;
                h += `<td class="c" data-r="${r}" data-c="${c}" ${rs>1?`rowspan="${rs}"`:''}${cs>1?`colspan="${cs}"`:''}><div class="cv"></div></td>`;
            }
            h += '</tr>';
        }
        h += '</tbody>';
        tbl.innerHTML = h;
        for (let rk in data) for (let ck in data[rk]) renderC(+rk, +ck);
        if (cursor) paint();
    }

    // ‚îÄ‚îÄ History (Undo) ‚îÄ‚îÄ
    let history = [];
    const MAX_HISTORY = 50;

    function pushHistory() {
        if (history.length >= MAX_HISTORY) history.shift();
        // Deep copy data and merges
        history.push({
            data: JSON.parse(JSON.stringify(data)),
            merges: JSON.parse(JSON.stringify(merges))
        });
    }

    window.undo = function() {
        if (history.length === 0) return;
        const state = history.pop();
        data = state.data;
        merges = state.merges;
        updateOccupied();
        buildTable();
        // Mark all as dirty to ensure save
        for (let r in data) for (let c in data[r]) dirty.add(`${r},${c}`);
        save();
    };

    // ‚îÄ‚îÄ Cell data ‚îÄ‚îÄ
    function D(r,c) {
        return (data[r] && data[r][c]) || {v:'',b:false,i:false,u:false,a:'left',fg:'',bg:'',fs:0,link:'',bt:false,br:false,bb:false,bl:false};
    }
    function setD(r,c,p,recordHistory=true) {
        if (recordHistory) pushHistory();
        if (!data[r]) data[r] = {};
        data[r][c] = {...D(r,c), ...p};
        dirty.add(`${r},${c}`);
        renderC(r,c);
        save();
    }
    function getEl(r,c) { return tbl.querySelector(`td.c[data-r="${r}"][data-c="${c}"]`); }

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    function renderC(r,c) {
        const td = getEl(r,c); if (!td) return;
        const d = D(r,c), dv = td.querySelector('.cv');
        if (!dv) return;
        if (d.link) {
            dv.innerHTML = `<a href="${esc(d.link)}" target="_blank">${esc(d.v || d.link)}</a>`;
        } else {
            dv.textContent = d.v;
        }
        dv.style.fontWeight = d.b ? '700' : '400';
        dv.style.fontStyle = d.i ? 'italic' : 'normal';
        dv.style.textDecoration = d.u ? 'underline' : 'none';
        dv.style.textAlign = d.a || 'left';
        dv.style.color = d.fg || '#333';
        dv.style.fontSize = d.fs ? d.fs + 'px' : '12px';
        dv.style.lineHeight = d.fs ? (d.fs + 8) + 'px' : '22px';
        
        // Flex alignment for centers
        if (d.a === 'center') {
            dv.style.display = 'flex'; dv.style.justifyContent = 'center'; dv.style.alignItems = 'center';
        } else if (d.a === 'right') {
            dv.style.display = 'block'; dv.style.textAlign = 'right';
        } else {
            dv.style.display = 'block'; dv.style.textAlign = 'left';
        }

        td.style.background = d.bg || '#fff';
        // Borders
        td.style.borderTop = d.bt ? '2px solid #333' : '';
        td.style.borderRight = d.br ? '2px solid #333' : '';
        td.style.borderBottom = d.bb ? '2px solid #333' : '';
        td.style.borderLeft = d.bl ? '2px solid #333' : '';
    }

    // ‚îÄ‚îÄ Save / Load ‚îÄ‚îÄ
    function save() {
        document.getElementById('sStatus').textContent = 'Saving...';
        document.getElementById('sDot').classList.remove('saved');
        clearTimeout(saveT);
        saveT = setTimeout(flush, 600);
    }
    function flush() {
        if (!dirty.size) return;
        const ups = [];
        dirty.forEach(k => {
            const [r,c] = k.split(',').map(Number);
            const d = D(r,c);
            ups.push({row:r, col:c, content: JSON.stringify({
                value:d.v, bold:d.b, italic:d.i, underline:d.u, align:d.a,
                fg:d.fg, bg:d.bg, fontSize:d.fs, link:d.link,
                borderTop:d.bt, borderRight:d.br, borderBottom:d.bb, borderLeft:d.bl
            })});
        });
        dirty.clear();
        fetch(`/api/sheets/${SID}/bulk_update`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({cells: ups})
        }).then(() => {
            document.getElementById('sStatus').textContent = 'Saved';
            document.getElementById('sDot').classList.add('saved');
        }).catch(() => {
            document.getElementById('sStatus').textContent = 'Error';
        });
    }

    fetch(`/api/sheets/${SID}/data`).then(r => r.json()).then(sd => {
        for (let rk in sd) for (let ck in sd[rk]) {
            let p; try { p = JSON.parse(sd[rk][ck]); } catch { p = {value: sd[rk][ck]}; }
            if (!data[rk]) data[rk] = {};
            data[rk][ck] = {
                v: p.value||'', b:!!p.bold, i:!!p.italic, u:!!p.underline, a:p.align||'left',
                fg:p.fg||'', bg:p.bg||'', fs:p.fontSize||0, link:p.link||'',
                bt:!!p.borderTop, br:!!p.borderRight, bb:!!p.borderBottom, bl:!!p.borderLeft
            };
        }
        buildTable();
        document.getElementById('sStatus').textContent = 'Ready';
        document.getElementById('sDot').classList.add('saved');
    });

    // ‚îÄ‚îÄ Selection ‚îÄ‚îÄ
    function sRange() {
        if (!anchor || !selEnd) return null;
        return {r1:Math.min(anchor.r,selEnd.r), c1:Math.min(anchor.c,selEnd.c),
                r2:Math.max(anchor.r,selEnd.r), c2:Math.max(anchor.c,selEnd.c)};
    }
    function clearSel() {
        tbl.querySelectorAll('.sel,.active').forEach(e => e.classList.remove('sel','active'));
        tbl.querySelectorAll('.ch.hl,.rh.hl').forEach(e => e.classList.remove('hl'));
    }
    function paint() {
        clearSel();
        const rng = sRange(); if (!rng) return;
        for (let r = rng.r1; r <= rng.r2; r++) {
            for (let c = rng.c1; c <= rng.c2; c++) { const td = getEl(r,c); if (td) td.classList.add('sel'); }
            const rh = tbl.querySelector(`td.rh[data-r="${r}"]`); if (rh) rh.classList.add('hl');
        }
        for (let c = rng.c1; c <= rng.c2; c++) {
            const ch = tbl.querySelector(`th.ch[data-c="${c}"]`); if (ch) ch.classList.add('hl');
        }
        if (cursor) { const ac = getEl(cursor.r, cursor.c); if (ac) ac.classList.add('active'); }
        updRef(); updFoot(); updToolbar();
    }
    function updRef() {
        if (cursor) { cellRef.textContent = `${L(cursor.c)}${cursor.r+1}`; formulaInput.value = D(cursor.r,cursor.c).v; }
    }
    function updFoot() {
        const rng = sRange(); if (!rng) { footInfo.textContent = ''; return; }
        const cnt = (rng.r2-rng.r1+1)*(rng.c2-rng.c1+1);
        if (cnt <= 1) { footInfo.textContent = ''; return; }
        let sum = 0, nums = 0;
        for (let r = rng.r1; r <= rng.r2; r++) for (let c = rng.c1; c <= rng.c2; c++) {
            const v = parseFloat(D(r,c).v); if (!isNaN(v)) { sum += v; nums++; }
        }
        let t = `${cnt} cells`;
        if (nums > 0) t += ` ¬∑ Sum: ${sum} ¬∑ Avg: ${(sum/nums).toFixed(2)} ¬∑ Count: ${nums}`;
        footInfo.textContent = t;
    }
    function updToolbar() {
        if (!cursor) return;
        const d = D(cursor.r, cursor.c);
        document.getElementById('tbB').classList.toggle('active', d.b);
        document.getElementById('tbI').classList.toggle('active', d.i);
        document.getElementById('tbU').classList.toggle('active', d.u);
        document.getElementById('tbFs').value = d.fs || 12;
        if (d.fg) { document.getElementById('tbFg').value = d.fg; document.getElementById('fgBar').style.background = d.fg; }
        if (d.bg) { document.getElementById('tbBg').value = d.bg; document.getElementById('bgBar').style.background = d.bg; }
    }
    function sel(r,c,ext) {
        stopEdit(); cursor = {r,c};
        if (!ext) anchor = {r,c};
        selEnd = {r,c}; paint(); gw.focus();
    }

    // ‚îÄ‚îÄ Mouse ‚îÄ‚îÄ
    tbl.addEventListener('mousedown', e => {
        // Resize handles
        const colH = e.target.closest('.col-resize');
        if (colH) { resizing = {type:'col', idx:+colH.dataset.c, startX:e.clientX, startW:colW[+colH.dataset.c]}; e.preventDefault(); return; }
        const rowH2 = e.target.closest('.row-resize');
        if (rowH2) { resizing = {type:'row', idx:+rowH2.dataset.r, startY:e.clientY, startH:rowH[+rowH2.dataset.r]}; e.preventDefault(); return; }

        const td = e.target.closest('td.c'); if (!td) return;
        const r = +td.dataset.r, c = +td.dataset.c;
        if (e.shiftKey && anchor) { selEnd = {r,c}; cursor = {r,c}; }
        else sel(r,c,false);
        dragging = true; paint(); e.preventDefault(); gw.focus();
    });
    document.addEventListener('mousemove', e => {
        if (resizing) {
            if (resizing.type === 'col') {
                colW[resizing.idx] = Math.max(30, resizing.startW + (e.clientX - resizing.startX));
                const cols = tbl.querySelectorAll('colgroup col');
                if (cols[resizing.idx+1]) cols[resizing.idx+1].style.width = colW[resizing.idx] + 'px';
            } else {
                rowH[resizing.idx] = Math.max(16, resizing.startH + (e.clientY - resizing.startY));
                const rows = tbl.querySelectorAll('tbody tr');
                if (rows[resizing.idx]) rows[resizing.idx].style.height = rowH[resizing.idx] + 'px';
            }
            return;
        }
        if (!dragging) return;
        const td = e.target.closest('td.c'); if (!td) return;
        selEnd = {r:+td.dataset.r, c:+td.dataset.c}; cursor = {...selEnd}; paint();
    });
    document.addEventListener('mouseup', () => { dragging = false; resizing = null; });

    // ‚îÄ‚îÄ Double-click edit ‚îÄ‚îÄ
    tbl.addEventListener('dblclick', e => {
        const td = e.target.closest('td.c'); if (!td) return;
        startEdit(+td.dataset.r, +td.dataset.c);
    });

    function startEdit(r,c) {
        stopEdit(); editing = true; editCell = {r,c};
        const td = getEl(r,c); if (!td) return; td.classList.add('editing');
        const d = D(r,c);
        const inp = document.createElement('input');
        inp.type = 'text'; inp.className = 'gs-edit'; inp.value = d.v;
        inp.style.fontSize = (d.fs || 12) + 'px';
        inp.style.fontWeight = d.b ? '700' : '400';
        inp.style.fontStyle = d.i ? 'italic' : 'normal';
        td.appendChild(inp); inp.focus(); inp.select();
        formulaInput.value = d.v;
        inp.addEventListener('input', () => { formulaInput.value = inp.value; });
        inp.addEventListener('keydown', ev => {
            if (ev.key === 'Enter') { commit(inp.value); move(1,0); }
            else if (ev.key === 'Tab') { ev.preventDefault(); commit(inp.value); move(0, ev.shiftKey ? -1 : 1); }
            else if (ev.key === 'Escape') { stopEdit(); gw.focus(); }
        });
        inp.addEventListener('blur', () => { if (editing && editCell) commit(inp.value); });
    }
    function commit(v) { if (!editCell) return; setD(editCell.r, editCell.c, {v}); stopEdit(); gw.focus(); }
    function stopEdit() {
        if (!editing) return; editing = false;
        const inp = tbl.querySelector('.gs-edit'); if (inp) inp.remove();
        tbl.querySelectorAll('.editing').forEach(e => e.classList.remove('editing'));
        editCell = null;
    }
    function move(dr,dc) {
        if (!cursor) return;
        sel(Math.max(0, Math.min(R-1, cursor.r+dr)), Math.max(0, Math.min(C-1, cursor.c+dc)), false);
    }

    // ‚îÄ‚îÄ Formula bar ‚îÄ‚îÄ
    formulaInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && cursor) {
            setD(cursor.r, cursor.c, {v: formulaInput.value});
            gw.focus(); move(1,0);
        }
    });

    // ‚îÄ‚îÄ Keyboard ‚îÄ‚îÄ
    gw.addEventListener('keydown', e => {
        if (editing) return;
        if (e.key.startsWith('Arrow')) {
            e.preventDefault();
            const dr = e.key==='ArrowDown' ? 1 : e.key==='ArrowUp' ? -1 : 0;
            const dc = e.key==='ArrowRight' ? 1 : e.key==='ArrowLeft' ? -1 : 0;
            if (e.shiftKey && anchor) {
                selEnd = {r:Math.max(0,Math.min(R-1,(selEnd||cursor).r+dr)),
                          c:Math.max(0,Math.min(C-1,(selEnd||cursor).c+dc))};
                cursor = {...selEnd}; paint();
            } else move(dr,dc);
            return;
        }
        if (e.key === 'Tab') { e.preventDefault(); move(0, e.shiftKey ? -1 : 1); return; }
        if (e.key === 'Enter') { if (cursor) startEdit(cursor.r, cursor.c); return; }
        if (e.key === 'Delete' || e.key === 'Backspace') {
            e.preventDefault();
            const rng = sRange();
            if (rng) {
                pushHistory();
                for (let r = rng.r1; r <= rng.r2; r++) for (let c = rng.c1; c <= rng.c2; c++) setD(r,c,{v:''}, false);
            }
            return;
        }
        if (e.ctrlKey || e.metaKey) {
            if (e.key === 'z') { e.preventDefault(); undo(); return; }
            if (e.key === 'b') { e.preventDefault(); fmt('bold'); return; }
            if (e.key === 'i') { e.preventDefault(); fmt('italic'); return; }
            if (e.key === 'u') { e.preventDefault(); fmt('underline'); return; }
            if (e.key === 'a') { e.preventDefault(); anchor={r:0,c:0}; selEnd={r:R-1,c:C-1}; cursor={r:0,c:0}; paint(); return; }
            return;
        }
        if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && cursor) startEdit(cursor.r, cursor.c);
    });

    // ‚îÄ‚îÄ Paste ‚îÄ‚îÄ
    gw.addEventListener('paste', e => {
        if (editing) return; e.preventDefault();
        const txt = (e.clipboardData || window.clipboardData).getData('text');
        if (!txt || !cursor) return;
        pushHistory();
        const rows = txt.split(/\r?\n/).filter(r => r.length > 0);
        const sr = cursor.r, sc = cursor.c;
        rows.forEach((rs, ri) => {
            rs.split('\t').forEach((v, ci) => {
                const tr = sr+ri, tc = sc+ci;
                if (tr < R && tc < C) setD(tr, tc, {v}, false);
            });
        });
        selEnd = {r:Math.min(sr+rows.length-1,R-1), c:Math.min(sc+(rows[0]?rows[0].split('\t').length-1:0),C-1)};
        paint();
    });

    // ‚îÄ‚îÄ Copy ‚îÄ‚îÄ
    gw.addEventListener('copy', e => {
        if (editing) return; e.preventDefault();
        const rng = sRange(); if (!rng) return;
        let tsv = '';
        for (let r = rng.r1; r <= rng.r2; r++) {
            const rv = []; for (let c = rng.c1; c <= rng.c2; c++) rv.push(D(r,c).v);
            tsv += rv.join('\t') + '\n';
        }
        e.clipboardData.setData('text/plain', tsv);
    });

    // ‚îÄ‚îÄ Format functions ‚îÄ‚îÄ
    window.fmt = function(f) {
        const rng = sRange(); if (!rng) return;
        pushHistory();
        for (let r = rng.r1; r <= rng.r2; r++) for (let c = rng.c1; c <= rng.c2; c++) {
            const d = D(r,c);
            if (f === 'bold') setD(r,c,{b:!d.b}, false);
            else if (f === 'italic') setD(r,c,{i:!d.i}, false);
            else if (f === 'underline') setD(r,c,{u:!d.u}, false);
            else if (f === 'left') setD(r,c,{a:'left'}, false);
            else if (f === 'center') setD(r,c,{a:'center'}, false);
            else if (f === 'right') setD(r,c,{a:'right'}, false);
        }
        paint();
    };

    window.fmtFs = function(size) {
        const rng = sRange(); if (!rng) return;
        pushHistory();
        for (let r = rng.r1; r <= rng.r2; r++) for (let c = rng.c1; c <= rng.c2; c++) setD(r,c,{fs:size}, false);
    };

    window.fmtColor = function(type, color) {
        const rng = sRange(); if (!rng) return;
        pushHistory();
        const bar = document.getElementById(type === 'fg' ? 'fgBar' : 'bgBar');
        bar.style.background = color;
        for (let r = rng.r1; r <= rng.r2; r++) for (let c = rng.c1; c <= rng.c2; c++) {
            if (type === 'fg') setD(r,c,{fg:color}, false);
            else setD(r,c,{bg:color}, false);
        }
    };

    // ‚îÄ‚îÄ Borders ‚îÄ‚îÄ
    window.fmtBorder = function(type) {
        const rng = sRange(); if (!rng) return;
        pushHistory();
        closeAllDD();
        for (let r = rng.r1; r <= rng.r2; r++) for (let c = rng.c1; c <= rng.c2; c++) {
            if (type === 'all') setD(r,c,{bt:true,br:true,bb:true,bl:true}, false);
            else if (type === 'none') setD(r,c,{bt:false,br:false,bb:false,bl:false}, false);
            else if (type === 'outer') {
                setD(r,c,{
                    bt: r === rng.r1, bb: r === rng.r2,
                    bl: c === rng.c1, br: c === rng.c2
                }, false);
            }
            else if (type === 'top') setD(r,c,{bt: r === rng.r1}, false);
            else if (type === 'bottom') setD(r,c,{bb: r === rng.r2}, false);
            else if (type === 'left') setD(r,c,{bl: c === rng.c1}, false);
            else if (type === 'right') setD(r,c,{br: c === rng.c2}, false);
        }
    };

    // ‚îÄ‚îÄ Merge ‚îÄ‚îÄ
    window.doMerge = function() {
        const rng = sRange(); if (!rng) return;
        if (rng.r1 === rng.r2 && rng.c1 === rng.c2) return;
        pushHistory();
        closeAllDD();
        // Remove overlapping
        merges = merges.filter(m => m.r2 < rng.r1 || m.r1 > rng.r2 || m.c2 < rng.c1 || m.c1 > rng.c2);
        merges.push({r1:rng.r1, c1:rng.c1, r2:rng.r2, c2:rng.c2});
        updateOccupied();
        buildTable();
    };
    window.unMerge = function() {
        const rng = sRange(); if (!rng) return;
        pushHistory();
        closeAllDD();
        // Remove any merge that intersects with selection
        merges = merges.filter(m => !(m.r1 >= rng.r1 && m.r2 <= rng.r2 && m.c1 >= rng.c1 && m.c2 <= rng.c2));
        updateOccupied();
        buildTable();
    };

    // ‚îÄ‚îÄ Hyperlink ‚îÄ‚îÄ
    window.addLink = function() {
        if (!cursor) return;
        const d = D(cursor.r, cursor.c);
        const url = prompt('Enter URL:', d.link || 'https://');
        if (url === null) return;
        pushHistory();
        setD(cursor.r, cursor.c, {link: url || ''}, false);
        if (url && !d.v) setD(cursor.r, cursor.c, {v: url}, false);
    };

    // ‚îÄ‚îÄ Dropdown toggle ‚îÄ‚îÄ
    window.toggleDD = function(id) {
        const el = document.getElementById(id);
        el.classList.toggle('open');
    };
    function closeAllDD() { document.querySelectorAll('.gs-dropdown.open').forEach(d => d.classList.remove('open')); }
    document.addEventListener('click', e => {
        if (!e.target.closest('.gs-dropdown')) closeAllDD();
    });

    // ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
    // ‚îÄ‚îÄ Export CSV ‚îÄ‚îÄ
    window.exportCSV = function() {
        let rows = [];
        // No headers, no row numbers
        for (let r = 0; r < R; r++) {
            let row = []; 
            for (let c = 0; c < C; c++) { 
                const v = D(r,c).v.replace(/"/g,'""'); 
                row.push('"'+v+'"'); 
            }
            rows.push(row.join(','));
        }
        const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob);
        a.download = '{{ sheet.name }}.csv'; 
        a.click();
    };

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    buildTable();
    sel(0,0,false);
    gw.focus();
})();
</script>
{% endblock %}
